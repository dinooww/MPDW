---
title: "Tugas Pertemuan 7"
author: "Sabitala Dinika G1401231089"
date: "2025-10-09"
format:
  html:
    self-contained: true
    embed-resources: true
    toc: true
    toc-title: "Daftar Isi"
    toc-depth: 3
    toc-location: left
    code-fold: false
    code-copy: true
editor:
  markdown:
    wrap: 72
---

# Import Library

```{r}
library(ggplot2)
library(tsibble)
library(tseries)
library(forecast)
library(TSA)
library(MASS)
library(readxl)
```

# Import Data

```{r}
jkt <- read_xlsx("~/punya dinoy/kuliah/Semester 5/MPDW/dataudarajkt.xlsx")
head(jkt)
```

Data yang digunakan adalah data kualitas udara di Jakarta dengan
variabel Y adalah pm10 (partikel berdiameter 10 mikron atau kurang).

# Split Data

Data akan di-split menjadi 80% data train dan 20% data test.

```{r}
# Hitung index batas 80%
n <- nrow(jkt)
n_train <- floor(0.8 * n)

# Split data
train_jkt <- jkt[1:n_train, ]
test_jkt  <- jkt[(n_train + 1):n, ]
```

```{r}
jkt.ts <- ts(train_jkt$pm10, start = 1, frequency = 1)
test.ts <- ts(test_jkt$pm10, start = 1, frequency = 1)
```

# Plot Time Series

```{r}
plot(jkt.ts,
     type = "l",
     xlab = "Periode",
     ylab = "PM10",
     main = "Plot Time Series PM10")
```

Berdasarkan plot time series tersebut, terlihat bahwa data tidak
stasioner dalam rataan, ditandai dengan adanya kecenderungan (tren)
positif, dan juga tidak stasioner dalam ragam, ditandai dengan adanya
lebar pita pada plot yang cenderung berbeda-beda.

# Cek Kestasioneran Data

## Kestasioneran dalam Rataan

### Plot ACF

```{r}
acf(jkt.ts, main="Plot ACF PM10")
```

Plot ACF PM10 menunjukkan korelasi yang menurun secara perlahan pada
banyak lag, sehingga menjadi indikasi kuat bahwa deret tidak stasioner
dalam rataan.

### Uji ADF

```{r}
tseries::adf.test(jkt.ts)
```

Berdasarkan uji ADF tersebut, didapat p-value = 0.1092 lebih besar dari
taraf nyata 5% sehingga gagal tolak $H_0$ yang menyatakan bahwa data
tidak stasioner dalam rataan. Hal ini sesuai dengan hasil eksplorasi
menggunakan plot time series dan plot ACF.

## Kestasioneran dalam Ragam

### Plot Box-Cox

```{r}
bc <- boxcox(jkt.ts ~ train_jkt$periode, lambda = seq(-1, 3, 0.001))
lambda <- bc$x[which.max(bc$y)]
lambda
```

```{r}
# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Hasil uji Box-Cox menunjukkan bahwa nilai lambda optimal berada pada
1.603 dengan selang kepercayaan 95% antara 0.957 hingga 2.279. Karena
nilai λ = 1 termasuk dalam selang kepercayaannya, maka ragam data PM10
stasioner. Artinya, data dikatakan homoskedastisitas. Namun, batas bawah
sangat mendekati nilai 1 dan untuk mencegah perubahan kestasioneran
setelah melakukan differencing, maka penanganan ketidakstasioneran dalam
ragam tetap dilakukan, yaitu dengan transformasi Box-Cox.

# Penanganan Ketidakstasioneran Data

## Transformasi Box-Cox

```{r}
jkt_transformasi <- BoxCox(jkt.ts, lambda = "auto")

lambda_terpilih <- attr(jkt_transformasi, "lambda")
print(paste("Lambda optimal:", lambda_terpilih))

plot(jkt_transformasi, type="l", main="Setelah Transformasi Box-Cox")
```

## Differencing Ordo 1

```{r}
jkt_diff1 <- diff(jkt_transformasi, differences = 1)
plot(jkt_diff1,
     type = "l",
     xlab = "Periode",
     ylab = "PM10",
     main = "Setelah Differencing Ordo 1")
```

Setelah dilakukan first differencing pada data PM10, pola fluktuasinya
terlihat sudah berpusat di sekitar nol sepanjang deret waktu. Tren naik
atau turun yang sebelumnya muncul pada data asli sudah tidak tampak
lagi, sehingga rata-rata dapat dianggap stabil dari waktu ke waktu.
Namun, ragam pada plot tersebut masih terlihat tidak menyebar dengan
cukup konstan, maka dilakukan differencing ordo 2.

## Differencing Ordo 2

```{r}
jkt_diff2 <- diff(jkt_diff1, differences = 2)
plot(jkt_diff2,
     type = "l",
     xlab = "Periode",
     ylab = "PM10",
     main = "Setelah Differencing Ordo 2")
```

Setelah dilakukan differencing ordo 2, terlihat ragam sudah menyebar
dengan cukup konstan sepanjang deret waktu dan dapat dilanjut untuk cek
kestasioneran data.

# Pengecekan Kembali Kestasioneran Data

## Kestasioneran dalam Rataan

### Plot ACF

```{r}
acf(jkt_diff2, main="Plot ACF PM10 Setelah Penanganan")
```

Dari plot ACF di atas setelah dilakukan differencing ordo 1, terlihat
bahwa plot ACF di atas sudah tidak mengalami penurunan perlahan dan
hanya sedikit lag yang signifikan pada plot ACF. Hal ini menunjukkan
bahwa data sudah stasioner dalam rataan.

### Uji ADF

```{r}
tseries::adf.test(jkt_diff2)
```

Berdasarkan uji ADF tersebut, didapat p-value = 0.01 yang lebih kecil
dari taraf nyata 5% sehingga tolak $H_0$, yang artinya data sudah
stasioner dalam rataan. Hal ini menunjukkan bahwa differencing berhasil
menangani ketidakstasioneran data dalam rataan. Hal ini sesuai dengan
hasil eksplorasi menggunakan plot time series dan plot ACF.

## Kestasioneran dalam Ragam

### Plot Box-Cox

```{r}
index <- seq(1:length(jkt_diff2))

# Uji Box-Cox
bc <- boxcox(
  jkt_diff2 - min(jkt_diff2) + 1 ~ index,
  lambda = seq(-1, 3, by = 0.001)
)
lambda
```

```{r}
# Selang kepercayaan 95% untuk lambda
ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

# Batas bawah dan batas atas
ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

Hasil uji Box-Cox menunjukkan bahwa nilai lambda optimal berada pada
1.603 dengan selang kepercayaan 95% antara 0.856 hingga 1.568. Karena
nilai λ = 1 termasuk dalam selang kepercayaannya, maka ragam data PM10
sudah stasioner. Artinya, data dikatakan homoskedastisitas.

# Pemodelan ARIMA

## Identifikasi Model

### Plot ACF

```{r}
acf(jkt_diff2)
```

Berdasarkan plot tersebut, terlihat bahwa plot ACF cenderung cuts off
pada lag ke 1, sehingga jika plot PACF dianggap tails off, maka model
tentatifnya adalah ARIMA(0,2,1).

### Plot PACF

```{r}
pacf(jkt_diff2)
```

Berdasarkan plot tersebut, terlihat bahwa plot PACF cenderung tails off.

### Plot EACF

```{r}
eacf(jkt_diff2)
```

Identifikasi model menggunakan plot EACF dilakukan dengan melihat ujung
segitiga pada pola segitiga nol. Dalam hal ini model tentatif yang
terbentuk adalah ARIMA(0,2,2), ARIMA(0,2,3), ARIMA(1,2,3), dan
ARIMA(1,2,4).

## Pendugaan Parameter Model Tentatif

### ARIMA(0,2,1)

```{r}
model1.da=Arima(jkt_diff2, order=c(0,2,1),method="ML")
summary(model1.da)
```

```{r}
lmtest::coeftest(model1.da)
```

### ARIMA(0,2,2)

```{r}
model2.da=Arima(jkt_diff2, order=c(0,2,2),method="ML")
summary(model2.da)
```

```{r}
lmtest::coeftest(model2.da)
```

### ARIMA(0,2,3)

```{r}
model3.da=Arima(jkt_diff2, order=c(0,2,3),method="ML")
summary(model3.da)
```

```{r}
lmtest::coeftest(model3.da)
```

### ARIMA(1,2,3)

```{r}
model4.da=Arima(jkt_diff2, order=c(1,2,3),method="ML")
summary(model4.da)
```

```{r}
lmtest::coeftest(model4.da)
```

### ARIMA(1,2,4)

```{r}
model5.da=Arima(jkt_diff2, order=c(1,2,4),method="ML")
summary(model5.da)
```

```{r}
lmtest::coeftest(model5.da)
```

### Ringkasan AIC

```{r}
model_tentatif <- data.frame(
  Model = c("ARIMA(0,2,1)","ARIMA(0,2,2)","ARIMA(0,2,3)", "ARIMA(1,2,3)", "ARIMA(1,2,4)"),
  AIC   = c(AIC(model1.da),AIC(model2.da), AIC(model3.da), AIC(model4.da), AIC(model5.da)),
  BIC   = c(BIC(model1.da),BIC(model2.da), BIC(model3.da), BIC(model4.da), BIC(model5.da))
)

model_tentatif
```

Berdasarkan pendugaan parameter di atas, nilai AIC terkecil dimiliki
oleh model ARIMA(1,2,4) dan parameter model ARIMA(1,2,4) juga seluruhnya
signifikan sehingga model yang dipilih adalah model ARIMA(1,2,4).

## Analisis Sisaan

### Eksplorasi Sisaan

```{r}
sisaan.da <- model4.da$residuals

par(mfrow = c(2,2),    
    mar = c(4,4,2,1),  
    oma = c(0,0,2,0))  

# Q-Q Plot
qqnorm(sisaan.da, main = "Normal Q-Q Plot")
qqline(sisaan.da, col = "blue", lwd = 2)

# Plot Sisaan vs Waktu
plot(sisaan.da, type = "p",
     main = "Plot Sisaan vs Waktu",
     xlab = "Waktu", ylab = "Sisaan")

# ACF
acf(sisaan.da, main = "ACF Sisaan")

# PACF
pacf(sisaan.da, main = "PACF Sisaan")
```

Berdasarkan plot kuantil-kuantil normal, secara eksploratif terlihat
bahwa sisaan tidak sepenuhnya menyebar normal karena titik-titik
cenderung menyimpang dari garis biru. Selain itu, lebar pita sebaran
sisaan tampak tidak seragam, yang mengindikasikan adanya heterogenitas
ragam. Sementara itu, plot ACF dan PACF sisaan dari model ARIMA(1,2,3)
menunjukkan adanya spike signifikan pada 2 lag pertama, sehingga secara
visual sisaan dapat dianggap tidak saling bebas. Kondisi ini akan diuji
lebih lanjut dengan uji formal.

### Uji Formal

```{r}
# 1. Sisaan Menyebar Normal 
ks.test(sisaan.da,"pnorm")
```

H0 : Sisaan menyebar normal

H1 : Sisaan tidak menyebar normal

Berdasarkan uji KS tersebut, didapat p-value sebesar
$5.551 \times 10^{-16}$ yang kurang dari taraf nyata 5%, sehingga tolak
H0 dan menandakan bahwa sisaan tidak menyebar normal. Hal ini sesuai
dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.

```{r}
# 2. Sisaan saling bebas/tidak ada autokorelasi 
Box.test(sisaan.da, type = "Ljung")
```

H0 : Sisaan saling bebas

H1 : Sisaan tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat p-value sebesar 0.01318 yang
kurang dari taraf nyata 5% sehingga tolak H0 dan menandakan bahwa sisaan
tidak saling bebas. Hal ini sesuai dengan hasil eksplorasi.

```{r}
# 3. Sisaan homogen 
Box.test((sisaan.da)^2, type = "Ljung")
```

H0 : Ragam sisaan homogen

H1 : Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat
p-value sebesar 0.1139 yang lebih besar dari taraf nyata 5% sehingga tak
tolak H0 dan menandakan bahwa ragam sisaan homogen. Hal ini berbeda
dengan hasil eksplorasi.

```{r}
# 4. Nilai tengah sisaan sama dengan nol 
t.test(sisaan.da, mu = 0, conf.level = 0.95)
```

H0 : nilai tengah sisaan sama dengan 0

H1 : nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat p-value sebesar 0.4176 yang lebih
besar dari taraf nyata 5% sehingga tak tolak H0 dan menandakan bahwa
nilai tengah sisaan sama dengan nol.

## Overfitting

Tahapan selanjutnya adalah overfitting dilakukan dengan menaikkan orde
AR(p) dan MA(q) dari model ARIMA(1,2,4). Kandidat model overfitting
adalah ARIMA(2,2,4) dan ARIMA(1,2,5).

```{r}
# ARIMA(2,2,4)
model6.da=Arima(jkt_diff2, order=c(2,2,4),method="ML")
summary(model6.da)
```

```{r}
lmtest::coeftest(model6.da)
```

```{r}
# ARIMA(1,2,5)
model7.da=Arima(jkt_diff2, order=c(1,2,5),method="ML")
summary(model7.da)
```

```{r}
lmtest::coeftest(model7.da)
```

Kemudian dibandingkan antara model untuk overfitting :

```{r}
data.frame(
  Model = c("ARIMA(1,2,4)", "ARIMA(2,2,4)","ARIMA(1,2,5)"),
  AIC   = c(AIC(model5.da),AIC(model6.da),AIC(model7.da)),
  BIC   = c(BIC(model5.da),BIC(model6.da),BIC(model7.da))
)
```

Hasil menunjukkan bahwa pada taraf nyata 5%, model dengan menaikkan satu
ordo AR (ARIMA(2,2,4)) memiliki nilai AIC yang lebih kecil dibandingkan
model sebelumnya (ARIMA(1,2,4)), serta seluruh parameternya juga
signifikan. Sehingga model ARIMA(2,2,4) dipilih sebagai model terbaik.

### Analisis Sisaan

#### Eksplorasi Sisaan

```{r}
sisaan.da6 <- model6.da$residuals

par(mfrow = c(2,2),    
    mar = c(4,4,2,1),  
    oma = c(0,0,2,0))  

# Q-Q Plot
qqnorm(sisaan.da, main = "Normal Q-Q Plot")
qqline(sisaan.da, col = "blue", lwd = 2)

# Plot Sisaan vs Waktu
plot(sisaan.da, type = "p",
     main = "Plot Sisaan vs Waktu",
     xlab = "Waktu", ylab = "Sisaan")

# ACF
acf(sisaan.da, main = "ACF Sisaan")

# PACF
pacf(sisaan.da, main = "PACF Sisaan")
```

Berdasarkan plot kuantil-kuantil normal, secara eksploratif terlihat
bahwa sisaan tidak sepenuhnya menyebar normal karena titik-titik
cenderung menyimpang dari garis biru. Selain itu, lebar pita sebaran
sisaan tampak tidak seragam, yang mengindikasikan adanya heterogenitas
ragam. Sementara itu, plot ACF dan PACF sisaan dari model ARIMA(2,2,4)
menunjukkan adanya spike signifikan, sehingga secara visual sisaan dapat
dianggap saling bebas. Kondisi ini akan diuji lebih lanjut dengan uji
formal.

#### Uji Formal

```{r}
# 1. Sisaan Menyebar Normal 
ks.test(sisaan.da6,"pnorm")
```

Berdasarkan uji KS tersebut, didapat p-value sebesar
$5.551 \times 10^{-16}$ yang kurang dari taraf nyata 5%, sehingga tolak
H0 dan menandakan bahwa sisaan tidak menyebar normal. Hal ini sesuai
dengan hasil eksplorasi menggunakan plot kuantil-kuantil normal.

```{r}
# 2. Sisaan saling bebas/tidak ada autokorelasi 
Box.test(sisaan.da6, type = "Ljung")
```

Berdasarkan uji Ljung-Box tersebut, didapat p-value sebesar 0.7877 yang
lebih besar dari taraf nyata 5% sehingga tak tolak H0 dan menandakan
bahwa sisaan saling bebas.

```{r}
# 3. Sisaan homogen 
Box.test((sisaan.da6)^2, type = "Ljung")
```

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat
p-value sebesar 0.2878 yang lebih besar dari taraf nyata 5% sehingga tak
tolak H0 dan menandakan bahwa ragam sisaan homogen.

```{r}
# 4. Nilai tengah sisaan sama dengan nol 
t.test(sisaan.da6, mu = 0, conf.level = 0.95)
```

H0 : nilai tengah sisaan sama dengan 0

H1 : nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat p-value sebesar 0.4291 yang lebih
besar dari taraf nyata 5% sehingga tak tolak H0 dan menandakan bahwa
nilai tengah sisaan sama dengan nol.

## Peramalan

```{r}
# ---FORECAST---
ramalan.da <- forecast::forecast(model6.da, h = length(test.ts))
data.ramalan.da <- ramalan.da$mean
plot(ramalan.da)
```

Berdasarkan hasil plot ramalan di atas, dapat dilihat bahwa ramalan ARIMA(2,2,4) cenderung stabil hingga akhir periode. Selanjutnya, dicari nilai akurasi antara hasil ramalan dengan data uji sebagai berikut.

```{r}
pt_akhir_train <- tail(jkt.ts, 2)  # 2 elemen terakhir sebelum differencing

forecast_diffinv <- diffinv(data.ramalan.da, differences = 2, xi = pt_akhir_train)

# Buang 2 elemen awal hasil diffinv
hasil <- forecast_diffinv[-(1:2)]

# Pastikan panjang = panjang test.ts
hasil <- hasil[1:length(test.ts)]

# Bandingkan aktual vs forecast
perbandingan.da <- cbind(
  Aktual   = test.ts,
  Forecast = hasil
)

print(head(perbandingan.da, 10))   
```

```{r}
# Hitung akurasi
akurasi_test <- accuracy(hasil, test.ts)
akurasi_test
```

Hasil peramalan dari model ARIMA(2,2,4) sangat buruk karena memiliki nilai MAPE yang sangat besar, lebih dari 10% yaitu 673.0384



